# üêõ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: 401 Unauthorized –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ /users –∏ /roles

## –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ `/v1/users` –∏–ª–∏ `/v1/roles` –ø–æ–ª—É—á–∞–ª–∏ –æ—à–∏–±–∫—É:

```json
{
  "success": false,
  "error": {
    "code": "UNAUTHORIZED",
    "message": "–¢–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω"
  }
}
```

---

## –ü—Ä–∏—á–∏–Ω–∞

–í `AuthContext.tsx` —Ñ—É–Ω–∫—Ü–∏—è `loadRoles()` –≤—ã–∑—ã–≤–∞–ª–∞—Å—å **–≤—Å–µ–≥–¥–∞** –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞, –¥–∞–∂–µ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:

```typescript
useEffect(() => {
  loadCurrentUser();  // ‚Üê –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–∫–µ–Ω ‚úÖ
  loadRoles();        // ‚Üê –ù–ï –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–∫–µ–Ω ‚ùå
}, []);
```

–≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –∑–∞–ø—Ä–æ—Å—É `/v1/roles` –±–µ–∑ —Ç–æ–∫–µ–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

---

## –†–µ—à–µ–Ω–∏–µ

### 1. –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π —Ä–æ–ª–µ–π

**–§–∞–π–ª:** `/contexts/AuthContext.tsx`

```typescript
const loadRoles = async () => {
  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–æ–ª–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
  const token = TokenManager.getToken();
  if (!token) {
    console.log('Skipping roles load - no token');
    return;
  }

  try {
    const response = await rolesApi.getAll();
    if (response.success && response.data) {
      setRoles(response.data as Role[]);
    }
  } catch (error) {
    console.error('Failed to load roles:', error);
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–æ–ª–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å
  }
};
```

### 2. –†–æ–ª–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ª–æ–≥–∏–Ω–∞

**–§–∞–π–ª:** `/contexts/AuthContext.tsx`

```typescript
const login = async (username: string, password: string, authType: 'local' | 'sso') => {
  try {
    const response = await authApi.login({ username, password, authType });

    if (response.success && response.data) {
      TokenManager.setToken(response.data.token);
      TokenManager.setRefreshToken(response.data.refreshToken);
      setUser(response.data.user as User);
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–æ–ª–∏ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ª–æ–≥–∏–Ω–∞
      try {
        const rolesResponse = await rolesApi.getAll();
        if (rolesResponse.success && rolesResponse.data) {
          setRoles(rolesResponse.data as Role[]);
        }
      } catch (error) {
        console.error('Failed to load roles after login:', error);
        // –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–æ–ª–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      }
    }
  } catch (error: any) {
    throw new Error(error.message || '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
  }
};
```

### 3. –î–æ–±–∞–≤–ª–µ–Ω —Ñ–ª–∞–≥ loading –≤ AuthContext

**–§–∞–π–ª:** `/contexts/AuthContext.tsx`

```typescript
interface AuthContextType {
  user: User | null;
  roles: Role[];
  loading: boolean;  // ‚Üê –ù–æ–≤–æ–µ –ø–æ–ª–µ
  // ...
}
```

---

## –†–µ–∑—É–ª—å—Ç–∞—Ç

‚úÖ –†–æ–ª–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è **—Ç–æ–ª—å–∫–æ** –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω  
‚úÖ –†–æ–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ª–æ–≥–∏–Ω–∞  
‚úÖ –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ù–ï –¥–µ–ª–∞–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å –∫ `/v1/roles`  
‚úÖ –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ä–æ–ª–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (DEFAULT_ROLES), –µ—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å  

---

## –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ñ–∞–π–ª—ã

- ‚úÖ `/contexts/AuthContext.tsx` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–æ–ª–µ–π
- ‚úÖ `/lib/api.ts` - –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ç–æ–¥–∞ `request()`
- ‚úÖ `/components/UsersSettingsPage.tsx` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ —Ç–∏–ø–∏–∑–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ API
- ‚úÖ `/backend/src/middleware/auth.js` - —É–±—Ä–∞–Ω–æ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –®–∞–≥ 1: –°–æ–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç
```bash
npm run build
```

### –®–∞–≥ 2: –†–∞–∑–≤–µ—Ä–Ω–∏—Ç–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
```bash
# –°–∫–æ–ø–∏—Ä—É–π—Ç–µ frontend
scp -r dist/* user@server:/var/www/utmn-security/frontend/

# –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π backend
scp -r backend/* user@server:/var/www/utmn-security/backend/

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å
sudo systemctl restart utmn-security
```

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É
1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
2. –û—Ç–∫—Ä–æ–π—Ç–µ DevTools (F12) ‚Üí Network tab
3. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É - –ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∑–∞–ø—Ä–æ—Å–∞ –∫ `/v1/roles`
4. –ó–∞–ª–æ–≥–∏–Ω—å—Ç–µ—Å—å (admin / Admin2025)
5. –ü–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—Ä–æ—Å –∫ `/v1/roles` —Å —Ç–æ–∫–µ–Ω–æ–º
6. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
7. –î–æ–ª–∂–Ω–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è —Ç–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –ë–î

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- –ï—Å–ª–∏ —Ä–æ–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è, –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ä–æ–ª–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- –û—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å, –Ω–æ –Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç —Ä–∞–±–æ—Ç—É

### –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
- –†–æ–ª–∏ –∏–∑ –ë–î –æ–±—ä–µ–¥–∏–Ω—è—é—Ç—Å—è —Å —Ä–æ–ª—è–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ä–æ–ª–∏ (`isSystem: true`) –Ω–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å

---

**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** 25.01.2026  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

**–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ:**
- ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- ‚úÖ –õ–æ–≥–∏–Ω –∏ –∑–∞–≥—Ä—É–∑–∫–∞ —Ä–æ–ª–µ–π
- ‚úÖ –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ API –∑–∞–ø—Ä–æ—Å—ã —Å —Ç–æ–∫–µ–Ω–æ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
